- name: Convert cron to systemd time units
  ansible.builtin.set_fact:
    ansible_pull_cron_job: "{{ ansible_pull_cron_job | combine({item: ansible_pull_cron_job[item] | regex_replace('\\*/', '0/')}) }}"
  loop:
    - hour
    - minute
    - day
  delegate_to: localhost
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd

- name: Create systemd service unit file
  ansible.builtin.template:
    src: ansible-pull.service.j2
    dest: /etc/systemd/system/ansible-pull.service
    mode: '0644'
  vars:
    job: "{{ ansible_pull_cron_job }}"
  notify: Reload systemd
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd

- name: Create systemd timer unit file
  ansible.builtin.template:
    src: ansible-pull.timer.j2
    dest: /etc/systemd/system/ansible-pull.timer
    mode: '0644'
  vars:
    job: "{{ ansible_pull_cron_job }}"
  notify: Reload systemd
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd

- name: Start and enable the systemd timer
  ansible.builtin.systemd:
    name: ansible-pull.timer
    enabled: true
    state: started
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd

- name: Create systemd unit file for initial setup
  ansible.builtin.template:
    src: ansible-pull-initial.service.j2
    dest: /etc/systemd/system/ansible-pull-initial.service
    mode: '0644'
  vars:
    job: "{{ ansible_pull_cron_job }}"
  notify: Reload systemd
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd

- name: Enable the systemd service for initial setup
  ansible.builtin.systemd:
    name: ansible-pull-initial.service
    enabled: true
  tags:
    - ansible_pull
    - ansible_pull_scheduler
    - systemd
